\documentclass[landscape, 11pt, svgnames]{article}

\usepackage[showframe]{geometry}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{listings}
\usepackage{tikz-uml}
\usepackage{amsfonts, amsmath, amsthm, amssymb}

\geometry{
  paperwidth=70cm,
  paperheight=120cm,
  margin=1cm
}

\date{\today}
\title{OpenST Protocol sequence diagrams v0.9.3}
\author{Benjamin Bollen}

\lstdefinelanguage{tikzuml}{language=[LaTeX]TeX, classoffset=0, morekeywords={umlbasiccomponent, umlprovidedinterface, umlrequiredinterface, umldelegateconnector, umlassemblyconnector, umlVHVassemblyconnector, umlHVHassemblyconnector, umlnote, umlusecase, umlactor, umlinherit, umlassoc, umlVHextend, umlinclude, umlstateinitial, umlbasicstate, umltrans, umlstatefinal, umlVHtrans, umlHVtrans, umldatabase, umlmulti, umlobject, umlfpart, umlcreatecall, umlclass, umlvirt, umlunicompo, umlimport, umlaggreg}, keywordstyle=\color{DarkBlue}, classoffset=1, morekeywords={umlcomponent, umlsystem, umlstate, umlseqdiag, umlcall, umlcallself, umlfragment, umlpackage}, keywordstyle=\color{DarkRed}, classoffset=0,  sensitive=true, morecomment=[l]{\%}}

\begin{document}
\begin{minipage}[b]{0.55\linewidth}
\Huge \color{NavyBlue} \textbf{OpenST Protocol v0.9.3 } \color{Black}\\ % Title
\huge\textit{sequence diagrams for stake and mint - Benjamin Bollen \& Pranay Valson, last edit \today}\\[1cm] % Subtitle
\end{minipage}

\begin{tikzpicture}
  \begin{umlseqdiag}
    \umlactor[class=Address]{Staker}
    \umlactor[class=Worker]{Facilitator}
    \umlactor[class=Worker]{Hunter}
    \umlboundary[class=ERC20]{OST} 
    \umlboundary[class=SK]{Branded Token Gate}
    \umlcontrol[class=SK]{OpenSTValue}
    \umlobject[class=SK]{SimpleStake}
    \umlobject[class=SK]{CoreUC}
    \umlcontrol[class=SK]{RegistrarVC}
    \umlboundary[class=Web3]{Value Chain}
    \umlactor[class=Worker, fill=purple!40]{Foundation}
    \umlboundary[class=Web3, fill=blue!40]{Utility Chain}
    \umlcontrol[class=SK, fill=blue!40]{RegistrarUC}
    \umlobject[class=SK, fill=blue!40]{CoreVC}
    \umlcontrol[class=SK, fill=blue!40]{OpenSTUtility}
    \umlboundary[class=ERC20, fill=blue!40]{Branded Token}
   \umlactor[class=Address, fill=blue!40]{Beneficiary} %Token Holder contract in v0.9.4
    
    %%%
    %%%  OpenST Mosaic (Foundation reports respective state root of )
    %%%
    
    \begin{umlfragment}[type=loop, name=mosaic]
      
      \begin{umlcall}[dt=193, op={new block(blockHeight, stateRoot)}]{Utility Chain}{Foundation}
        % Foundation report state root of Utility chain on CoreUC on value chain
        \begin{umlcall}[op={: report(UC, blockHeight, stateRoot)}]{Foundation}{RegistrarVC}
          \begin{umlcall}[op={: commit(blockHeight, stateRoot)}]{RegistrarVC}{CoreUC}
            % state root of utility chain got reported on value chain
            \begin{umlcall}[dt=10, type=return, op={emit CommittedStateRoot(UC, blockHeight, stateRoot)}]{CoreUC}{Facilitator}
            \end{umlcall}
          \end{umlcall}
        \end{umlcall}
      \end{umlcall}
          
      % Foundation report state root of Value chain on CoreVC on utility chain
      \begin{umlcall}[dt=205, op={new block(blockHeight, stateRoot)}]{Value Chain}{Foundation}
        \begin{umlcall}[op={: report(VC, blockHeight, stateRoot}]{Foundation}{RegistrarUC}
          % reporting through registrar is instant commit
          \begin{umlcall}[op={: commit(blockHeight, stateRoot)}]{RegistrarUC}{CoreVC}
            % state root of value chain got reported on utility chain
            \begin{umlcall}[dt=10, type=return, op={emit CommittedStateRoot(VC, blockHeight, stateRoot)}]{CoreVC}{Facilitator}
            \end{umlcall}
          \end{umlcall}
        \end{umlcall}
      \end{umlcall}
      
    \end{umlfragment}
    \umlnote[x=33, y=-27, width=180]{mosaic}{Placeholder for OpenST Mosaic game}
    
    %%%
    %%% Facilitator has observed a committed state root that includes the StakingIntentHash
    %%%
    
    % Facilitator submits claim for StakingIntentHash by presenting Merkle proof
    \begin{umlcall}[dt=15, op={: claimStakingIntentHash(StakingIntentHash, merkleProof[], committedBlockHeight)}, return={emit ValidatedStakingIntentHash(StakingIntentHash)}]{Facilitator}{OpenSTUtility}
      % OpenSTUtility checks StakingIntentHash against committed state root
      \begin{umlcall}[op={: getStateRoot(blockHeight)}, return={stateRoot @ blockHeight}]{OpenSTUtility}{CoreVC}
      \end{umlcall}
      % OpenSTUtility validate merkle proof
      \begin{umlcallself}[op={validate proof}]{OpenSTUtility}
      \end{umlcallself}
      % OpenSTUtility store valid StakingIntentHash
      \begin{umlcallself}[op={store valid StakingIntentHash}]{OpenSTUtility}
      \end{umlcallself}
    \end{umlcall}
    
    % Facilitator submits pre-image data for StakingIntentHash
    \begin{umlcall}[dt=5, op={: ConfirmStakingIntent(StakingIntentHash, uuid, hashLock, amountST, amountUT, stakingProcessor, stakingProcessorNonce, tokenHolder, unlockHeight)}, return={emit StakingIntentConfirmed(StakingIntentHash, nonce, unlockHeight, expirationHeight)}]{Facilitator}{OpenSTUtility}
      % OpenSTUtility asserts valid pre-image data for StakingIntentHash
      \begin{umlcallself}[op={assert valid pre-image data}]{OpenSTUtility}
      \end{umlcallself}
      % OpenSTUtility checks StakingIntentHash against committed state root
      \begin{umlcall}[op={: getLatestHeight()}, return={latestHeight}]{OpenSTUtility}{CoreVC}
      \end{umlcall}
      % OpenSTUtility asserts grace period before unlockHeight
      \begin{umlcallself}[op={assert grace period before unlockHeight}]{OpenSTUtility}
      \end{umlcallself}
      % OpenSTUtility store mint object with StakingIntentHash and expiration Height
      \begin{umlcallself}[op={store mint with expirationHeight}]{OpenSTUtility}
      \end{umlcallself}
    \end{umlcall}
    
    %%%
    %%% Facilitator has moved both value and utility chain to the first stage
    %%% and can now either proceed or revert by revealing the hash lock secret or await timeout
    %%%
    
    
  \end{umlseqdiag}
\end{tikzpicture}


\end{document}

